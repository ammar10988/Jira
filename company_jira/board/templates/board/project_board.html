
{% extends "base.html" %}
{% block title %}{{ project.key }} ‚Äì {{ project.name }}{% endblock %}

{% block content %}

{# ---- PROJECT HEADER WITH DELETE BUTTON ---- #}
<div class="project-header" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:1rem;">
  <div>
    <h1 class="page-title">{{ project.key }} ‚Äì {{ project.name }}</h1>
    <p class="page-subtitle">{{ project.description }}</p>
  </div>

  {% if user.is_authenticated and user.profile.role == "BOSS" or user.is_authenticated and user.profile.role == "LEAD" %}
    <form method="post"
          action="{% url 'project_delete' project.pk %}"
          onsubmit="return confirm('Delete the project {{ project.name }} and all its issues?');">
      {% csrf_token %}
      <button type="submit" class="btn-danger">Delete project</button>
    </form>
  {% endif %}
</div>

{# ---- TOP INFO ROW ---- #}
<div class="grid-3 card-grid-top">
  <div class="card">
    <h2>Description</h2>
    <p>{{ project.description|default:"No description yet." }}</p>
  </div>

  <div class="card">
    <h2>Issue date</h2>
    <p>{{ project.issue_date|date:"Y-m-d"|default:"‚Äî" }}</p>
  </div>

  <div class="card">
    <h2>Deadline date</h2>
    <p>{{ project.deadline_date|date:"Y-m-d"|default:"‚Äî" }}</p>
  </div>
</div>

{# ---- SECOND INFO ROW ---- #}
<div class="grid-3 card-grid-mid">
  <div class="card">
    <h2>SOP</h2>
    {% if project.sop %}
      <p>{{ project.sop|linebreaks }}</p>
    {% else %}
      <p class="empty">No SOP defined yet.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Attach file</h2>
    {% if project.attachments.all %}
      <ul>
        {% for att in project.attachments.all %}
          <li>
            <a href="{{ att.file.url }}" target="_blank">{{ att.filename }}</a>
            <span style="font-size:0.8rem;color:#9ca3af;">
              ({{ att.uploaded_by.username }}, {{ att.uploaded_at|date:"Y-m-d H:i" }})
            </span>
          </li>
        {% empty %}
          <li class="empty">No files yet.</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="empty">No files yet.</p>
    {% endif %}

    {% if project.reference_url %}
      <hr style="margin: 1rem 0; border: 0; border-top: 1px solid #e5e7eb;">
      <p class="project-link">
        <strong>Reference link:</strong>
        <a href="{{ project.reference_url }}"
          target="_blank"
          rel="noopener">
          {{ project.reference_url }}
        </a>
      </p>
    {% endif %}

    <form method="post" enctype="multipart/form-data" action="{% url 'project_add_attachment' project.pk %}">
      {% csrf_token %}
      {# You can keep your attachment form fields here if you add them later #}
    </form>
  </div>

  <div class="card">
    <h2>Members</h2>
    <p><strong>Owner:</strong> @{{ project.owner.username }}</p>
    {% if project.members.all %}
      <ul>
        {% for m in project.members.all %}
          <li>@{{ m.username }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="empty">No extra members assigned.</p>
    {% endif %}
  </div>
</div>

{# ---- KANBAN ROW ---- #}
<div class="board-columns">
  <div class="card column">
    <h2>To Do</h2>
    {% if todo %}
      {% for issue in todo %}
        <div class="issue-card priority-{{ issue.priority|lower }} {% if issue.is_overdue %}overdue{% endif %}">
          <div class="issue-title">
            <a href="{% url 'issue_detail' issue.pk %}">{{ issue.title }}</a>
          </div>
          <div class="issue-meta">
            {{ issue.get_priority_display }}
            {% if issue.assignee %} ¬∑ @{{ issue.assignee.username }}{% endif %}
            {% if issue.due_date %} ¬∑ Due {{ issue.due_date|date:"Y-m-d" }}{% endif %}
          </div>
          <a href="{% url 'issue_edit' issue.pk %}" class="issue-edit-link">Edit</a>
        </div>
      {% endfor %}
    {% else %}
      <p class="empty">No tasks</p>
    {% endif %}
  </div>

  <div class="card column">
    <h2>In Progress</h2>
    {% if in_progress %}
      {% for issue in in_progress %}
        <div class="issue-card priority-{{ issue.priority|lower }} {% if issue.is_overdue %}overdue{% endif %}">
          <div class="issue-title">
            <a href="{% url 'issue_detail' issue.pk %}">{{ issue.title }}</a>
          </div>
          <div class="issue-meta">
            {{ issue.get_priority_display }}
            {% if issue.assignee %} ¬∑ @{{ issue.assignee.username }}{% endif %}
            {% if issue.due_date %} ¬∑ Due {{ issue.due_date|date:"Y-m-d" }}{% endif %}
          </div>
          <a href="{% url 'issue_edit' issue.pk %}" class="issue-edit-link">Edit</a>
        </div>
      {% endfor %}
    {% else %}
      <p class="empty">No tasks</p>
    {% endif %}
  </div>

  <div class="card column">
    <h2>Done</h2>
    {% if done %}
      {% for issue in done %}
        <div class="issue-card priority-{{ issue.priority|lower }} {% if issue.is_overdue %}overdue{% endif %}">
          <div class="issue-title">
            <a href="{% url 'issue_detail' issue.pk %}">{{ issue.title }}</a>
          </div>
          <div class="issue-meta">
            {{ issue.get_priority_display }}
            {% if issue.assignee %} ¬∑ @{{ issue.assignee.username }}{% endif %}
            {% if issue.due_date %} ¬∑ Done {{ issue.updated_at|date:"Y-m-d" }}{% endif %}
          </div>
          <a href="{% url 'issue_edit' issue.pk %}" class="issue-edit-link">Edit</a>
        </div>
      {% endfor %}
    {% else %}
      <p class="empty">No tasks</p>
    {% endif %}
  </div>
</div>

<br><br>

{# ---------- PROJECT STATUS FORM ---------- #}
<form method="post" class="project-status-form">
  {% csrf_token %}
  
  {% if issue_form.non_field_errors %}
    <div class="form-errors">
      {{ issue_form.non_field_errors }}
    </div>
  {% endif %}

  {% for field in issue_form %}
    {% if field.errors %}
      <div class="field-error">
        <strong>{{ field.label }}:</strong> {{ field.errors|striptags }}
      </div>
    {% endif %}
  {% endfor %}

  <input type="hidden" name="action" value="status">
  <input type="hidden" name="title" value="Status update">

  <section class="card project-status-card spacing-card">
    <h2>Project status</h2>
    <p>Update your current status for this project. This will show up in <strong>My Tasks</strong>.</p>

    <div class="form-row">
      <label>Title</label>
      {{ issue_form.title }}
    </div>

    <div class="form-row">
      <label>Status</label>
      {{ issue_form.status }}
    </div>

    <div class="form-row">
      <label>Priority</label>
      {{ issue_form.priority }}
    </div>

    <div class="form-row">
      <label>Due date</label>
      {{ issue_form.due_date }}
    </div>

    <div class="form-row">
      <label>Assignee</label>
      {{ issue_form.assignee }}
    </div>

    <div class="form-row">
      <label>Members</label>
      {{ issue_form.members }}
      <span class="help-text">Everyone selected here will also see this in My Tasks.</span>
    </div>
    <br>
    <button type="submit" class="btn-primary">Save status</button>
  </section>
</form>

<br><br>

{# ---------- PROJECT ISSUE FORM ---------- #}
<form method="post" enctype="multipart/form-data" class="project-issue-form">
  {% csrf_token %}

  <input type="hidden" name="action" value="status_issue">
  <!-- Default values so IssueForm validation passes when employee files a blocker -->
  <input type="hidden" name="status" value="TODO">
  <input type="hidden" name="priority" value="LOW">

  <section class="card project-issue-card spacing-card">
    <h2>Project issue</h2>
    <p>If there‚Äôs an actual issue or blocker, describe it here and attach any file.</p>

    <div class="form-row">
      <label>Issue / status title</label>
      {{ issue_form.title }}
      {% if issue_form.title.errors %}
        <div class="field-error">{{ issue_form.title.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="form-row">
      <label>Description (optional)</label>
      {{ issue_form.description }}
      {% if issue_form.description.errors %}
        <div class="field-error">{{ issue_form.description.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="id_attachments">Issue file (optional)</label>

      <!-- Styled file input: hidden input + label so we can style like theme -->
      <input id="id_attachments" type="file" name="attachments" multiple style="display:none;">
      <div class="file-input-row">
        <label for="id_attachments" class="btn-file">
          <span class="file-icon">üìÅ</span> Choose file(s)
        </label>
        <span id="chosen-files" class="chosen-files">No files chosen</span>
      </div>

      <p class="help-text">
        Attach any PDF / spec / screenshot related to this issue (you can select multiple files).
      </p>
      {% if issue_form.non_field_errors %}
        <div class="form-errors">{{ issue_form.non_field_errors }}</div>
      {% endif %}
    </div>

    <div class="form-row form-actions">
      <!-- Primary-looking submit (green / rounded to match Save status) -->
      <button type="submit" class="btn-primary btn-submit">Submit</button>
    </div>
  </section>
</form>

{% endblock %}
